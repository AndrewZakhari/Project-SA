{% extends "base.html"%}
{% block content%}
<section class="container-fluid">
	<div class="row mb-4">
		<div class="col-12">
			<h1 class="display-6 fw-bold">Welcome, {{ first_name }}</h1>
			<p class="text-muted" id="dateTime"></p>
		</div>
	</div>

	<div>
		{% with messages = get_flashed_messages(with_categories=true) %}
		{% if messages %}
		{% for category, message in messages %}
		{% if message == 'notAllowed' %}
		<div class="alert alert-{{ category }}">

			<script>
				Swal.fire({
					icon: "error",
					title: "Oh...",
					text: "You are not enrolled in this Subject!",
				});
				let urlParams = new URLSearchParams(window.location.search);
				urlParams.delete('notAllowed');
				let newUrl = window.location.pathname;
				window.history.replaceState({}, document.title, newUrl);
			</script>

		</div>
		{% endif %}
		{% endfor %}
		{% endif %}
		{% endwith %}
	</div>

	<div class="row">
		{% for sub in subs %}
		<div class="col-md-4 col-lg-3 mb-4">
			<a href="/subject/{{sub.code}}" target="_blank" class="glass-card d-flex flex-column align-items-center justify-content-center text-decoration-none h-100">
				<div class="rounded-circle mb-3 d-flex align-items-center justify-content-center text-light fs-2 fw-bold shadow-sm" 
					 style="width: 80px; height: 80px; background: {{sub.color}};">
					{{ sub.logo }}
				</div>
				<h5 class="text-center mb-1" style="color: inherit;">{{ sub.name }}</h5>
				<small class="text-muted">{{ sub.created_date }}</small>
			</a>
		</div>
		{% endfor %}

		<div class="col-md-4 col-lg-3 mb-4">
			<a href="#" data-bs-toggle="modal" data-bs-target="#addSubjectModal" id="myButton" 
			   class="glass-card d-flex flex-column align-items-center justify-content-center text-decoration-none h-100"
			   style="border: 2px dashed var(--primary-color); background: rgba(108, 99, 255, 0.05);">
				<div class="rounded-circle mb-3 d-flex align-items-center justify-content-center text-light fs-2 fw-bold" 
					 style="width: 80px; height: 80px; background: var(--primary-color);">
					<i class="bi bi-plus"></i>
				</div>
				<h5 class="text-center mb-1" style="color: var(--primary-color);">Add Subject</h5>
			</a>
		</div>
	</div>
</section>

<!-- Modal -->
<div class="modal fade" id="addSubjectModal" tabindex="-1" aria-labelledby="addSubjectModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; border: none;">
			<div class="modal-header border-0">
				<h1 class="modal-title fs-5 fw-bold" id="addSubjectModalLabel">Add Subject</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				{% with messages = get_flashed_messages(with_categories=true) %}
				{% if messages %}
				{% for category, message in messages %}
				{% if message != 'notAllowed' %}
				<div class="alert alert-{{ category }}">
					{{ message }}
				</div>
				{% endif %}
				{% endfor %}
				{% endif %}
				{% endwith%}
				<form method="POST" action="/home" novalidate id="addSubjectForm">
					{{ form.hidden_tag() }}
					{% if role == "student"%}
					<div class="form-group mb-3">
						{{ form.subjectCode.label(class="form-label fw-bold") }}
						{% if form.subjectCode.errors %}
						{{ form.subjectCode(class="form-control is-invalid") }}
						<div class="invalid-feedback">
							{% for error in form.subjectCode.errors %}
							<span>{{ error }}</span>
							<script>
								Swal.fire({
									icon: "error",
									title: "Oh...",
									text: "You are not enrolled in this Subject!",
								});
							</script>
							{% endfor %}
						</div>
						{% else %}
						{{ form.subjectCode(class="form-control", id='user-input') }}
						{% endif %}
					</div>
					{% elif role == "teacher"%}
					<div class="form-group mb-3">
						{{ form.subjectName.label(class="form-label fw-bold") }}
						{% if form.subjectName.errors %}
						{{ form.subjectName(class="form-control is-invalid") }}
						<div class="invalid-feedback">
							{% for error in form.subjectName.errors %}
							<span>{{ error }}</span>
							{% endfor %}
						</div>
						<script> document.getElementById('myButton').click();</script>
						{% else %}
						{{ form.subjectName(class="form-control", id='user-input') }}
						{% endif %}
					</div>
					<div id="email-fields" class="form-group mb-3">
						{% for email in form.emails %}
						{{ email.label(class="form-label fw-bold") }}
						{% if email.errors %}
						{{ email(class="form-control is-invalid") }}
						<div class="invalid-feedback">
							{% for error in email.errors %}
							<span>{{ error }}</span>

							{% endfor %}
						</div>
						{% else %}
						{{ email(class="form-control") }}
						{% endif %}
						{% endfor %}
					</div>
					<button type="button" onclick="addEmailField()" class="btn btn-outline-primary btn-sm mb-3">Add Secondary
						Teacher</button>
					<br>
					<div id="books-fields" class="form-group mb-3">
						{% for book in form.books %}
						{{ book.label(class="form-label fw-bold") }}
						{% if book.errors %}
						{{ book(class="form-control is-invalid") }}
						<script>$('#addSubjectModal').modal('show')</script>
						<div class="invalid-feedback">
							{% for error in book.errors %}
							<span>{{ error }}</span>
							{% endfor %}
						</div>
						{% else %}
						{{ book(class="form-control") }}
						{% endif %}
						{% endfor %}
					</div>
					<button type="button" onclick="addBookField()" class="btn btn-outline-primary btn-sm mb-3">Add Books</button>
					<br>

					{% endif %}
					{% if message %}
					<script>
						Swal.fire({
							title: "Done!",
							text: "Subject Added Successfully!",
							icon: "success"
						});
					</script>
					{{endif}}
					{% endif %}

			</div>
			<div class="modal-footer border-0">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
					Close
				</button>
				{{ form.submit(class='btn btn-primary', id='submit-btn', disabled='disabled') }}
			</div>
			</form>
		</div>
	</div>
</div>
<script src="{{ url_for('static', filename='js/home.js') }}"></script>

<script>
	// Simple date time script
	function updateTime() {
		const now = new Date();
		const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
		document.getElementById('dateTime').textContent = now.toLocaleDateString('en-US', options);
	}
	updateTime();
	setInterval(updateTime, 60000);

	index = 1;
	function addEmailField()
	{
		var container = document.getElementById('email-fields');

		var label = document.createElement('label');
		label.setAttribute('for', `emails-${index}`);
		label.textContent = `#${index} Secondary Teacher Email`;
		label.classList.add('form-label', 'fw-bold', 'mt-2');

		var input = document.createElement('input');
		input.setAttribute('id', `emails-${index}`);
		input.setAttribute('name', `emails-${index}`);
		input.setAttribute('required', '');
		input.setAttribute('type', 'text');
		input.setAttribute('value', '');
		input.classList.add('form-control');

		container.appendChild(label);
		container.appendChild(input);
		index += 1;
	}
	index_book = 1;
	function addBookField()
	{
		var container = document.getElementById('books-fields');

		var label = document.createElement('label');
		label.setAttribute('for', `books-${index_book}`);
		label.textContent = `#${index_book} Google Drive Book link:`;
		label.classList.add('form-label', 'fw-bold', 'mt-2');

		var input = document.createElement('input');
		input.setAttribute('id', `books-${index_book}`);
		input.setAttribute('name', `books-${index_book}`);
		input.setAttribute('required', '');
		input.setAttribute('type', 'text');
		input.setAttribute('value', '');
		input.classList.add('form-control');

		container.appendChild(label);
		container.appendChild(input);
		index_book += 1;
	}

	document.getElementById('user-input').addEventListener('input', function ()
	{
		var inputValue = this.value.trim();
		var submitBtn = document.getElementById('submit-btn');

		if (inputValue.length > 0)
		{
			submitBtn.removeAttribute('disabled');
		} else
		{
			submitBtn.setAttribute('disabled', 'disabled');
		}
	});
</script>

{% if submit%}

<script>$('#addSubjectModal').modal('show')</script>

{% endif %}


{%endblock content%}